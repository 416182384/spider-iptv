name: Deploy IPTV Spider

on:
  push:
    branches:
      - main  # 当有代码推送到 main 分支时触发
  schedule:
    - cron: '0 2 * * *'  # 每天凌晨 2 点自动触发

jobs:
  deploy:
    runs-on: ubuntu-latest  # 使用最新的 Ubuntu 运行环境

    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: your_root_password
          MYSQL_USER: iptv_user
          MYSQL_PASSWORD: your_password
          MYSQL_DATABASE: iptv
          MYSQL_INITDB_SCRIPT: |  # 初始化 SQL 脚本
            SET GLOBAL sql_mode=(SELECT REPLACE(@@sql_mode,'ONLY_FULL_GROUP_BY',''));
        ports:
          - 3306:3306

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4  # 检出代码

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.9  # 设置 Python 版本

      - name: Cache Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Dependencies
        run: |
          pip3 install bs4
          pip3 install m3u8
          pip3 install requests
          pip3 install mysql-connector-python
          pip3 install pymysql
          pip3 install sqlalchemy
          pip3 install requests-html
          pip3 install lxml
          pip3 install aiomysql
          pip3 install opencv-python
          pip3 install timeout-decorator

      - name: Install FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg  # 安装 FFmpeg

      - name: Run Spider
        run: |
          # 获取 MySQL 服务的连接信息
          MYSQL_HOST=127.0.0.1
          MYSQL_USER=iptv_user
          MYSQL_PASSWORD=your_password
          MYSQL_DATABASE=iptv

          # 导出 API_TOKEN
          export API_TOKEN=${{ secrets.API_TOKEN }}
          # 导入数据库结构
          mysql -h $MYSQL_HOST -u $MYSQL_USER -p$MYSQL_PASSWORD $MYSQL_DATABASE < data/iptv_data.sql
          # 运行主程序
          python3 main.py

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: iptv-sources
          path: source/iptv.txt  # 上传生成的文件到 GitHub Actions 的 Artifact
